#! /usr/bin/env ruby

require "colorize"
require "clamp"
require "docker"
require "docker_map/image_set"

Excon.defaults[:ssl_verify_peer] = false

Clamp do

  def execute
    load_images
    image_set.roots.each do |root|
      display_image(root)
    end
  end

  private

  def image_set
    @image_set ||= DockerMap::ImageSet.new
  end

  def load_images
    Docker::Image.all(:all => true).each do |image|
      info = image_set[image.id]
      parent_id = image.info.fetch('ParentId')
      parent_id = nil if parent_id == ""
      if parent_id
        parent = image_set[parent_id]
        info.parent = parent
        parent.children << info
      end
      image.info.fetch('RepoTags').each do |tag|
        info.tags << tag unless tag == '<none>:<none>'
      end
    end
  end

  def display_image(image, prefix = "")
    puts "#{prefix}#{image.id[0..11]}"
    image.tags.to_a.sort.each do |tag|
      puts "#{prefix}  - #{tag.inspect}".colorize(:yellow)
    end
    image.children.each do |child|
      display_image(child, prefix + "  ")
    end
  end

end

